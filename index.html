<!DOCTYPE html>
<html>
    <head>
        <title>Messages</title>
        <style type="text/css">
            
            body {
                background-color: lightseagreen;
                /*#062544*/
            }

            #main {
                display: grid;

                grid-template-columns: repeat(5, 1fr);
                grid-template-rows: repeat(5, 1fr);

                background-color: lightblue;

                height: 97vh;

            }
            .box {
                background-color: lightgreen;
                padding: 5px;
            }
            #messages_out {
                grid-area: 2 / 1 / 5 / 1;
                overflow-y: auto;
            }
            #user_op {
                background: lightsteelblue;
            }

            @counter-style mess {
                system: cyclic;
                symbols: "|";
                suffix: " ";
            }

            #messlist {
                list-style-type: mess;
                
            }
            #connStat {
                color: red;
            }

        </style>
        <script
        src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
        crossorigin="anonymous"></script>
    </head>
    <body>

        <div id="main">
            
            <div class="box" id="user_op">
                <button id="notif_perm" onclick="notifget()">Allow notifications?</button>
                <!--<div id="nameBox">-->
                    <br>
                    <a href="login.html">Login</a>
                    <br>
                <!--</div>-->
                <input type="text" id="text-sub"> <button onclick="submitText()">Submit</button>
                <p>Active Users: <span id="active_users"></span></p>
                <p>Users Logged In: <span id="logged_users_c"></span></p>
                <h3 id="connStat"> --Not Connected-- </h3>
            </div>

            <!--<p id="messout"></p>-->
            <div id="messages_out" class='box'>
                <h1>Messages:</h1>
                <h3 id="curr_view"></h3>
                <ul id="messlist">

                </ul>
            </div>


            <div id="channels">
                <ul id="chanlist">

                </ul>
            </div>



        </div>


        

        <script>
            /*service workers*/
            //Help
            
            // Ess Vars
            let view = {channel_ident: 0};
            let channels = [];


            // Bulk Vars
            let text = document.getElementById("text-sub");
            let active_users_p = document.getElementById("active_users");
            let logged_in_users_p = document.getElementById("logged_users_c")
            let messlist = document.getElementById("messlist");
            let name_field = document.getElementById("name-in");
            let pass_in = document.getElementById("pass-in");
            let connStat = document.getElementById("connStat");
            let channlist = document.getElementById("channlist")
            // Bulk Vars ^




            var websocket = new WebSocket("wss://lillplp.com:6789/");


            function notifget() {
                Notification.requestPermission()                   
            }

            
              
            websocket.onopen = function (event) {
                //websocket.send(JSON.stringify({action: "connect", name: name_field.value}));
                connStat.style.color = "green";
                connStat.textContent = "--Connected--";
            }

            websocket.onclose = function (event) {
                connStat.style.color = "red";
                connStat.textContent = "--Not Connected--";
            }

            websocket.onerror = function (event) {
                connStat.style.color = "orange";
                connStat.textContent = "--Error--";
            }
            
            websocket.onmessage = function (event) {
                data = JSON.parse(event.data);
                console.log(data)

                //document.getElementById("messlist").insertAdjacentHTML("beforeend", "<li> " + value.message + " </li>");

                switch (data.type) {
                    case "mess_all":
                        //data.data
                        for (let x in data.data) {
                            messHandle(data.data[x])
                        };
                        break;
                    case "users":
                        active_users_p.innerHTML = data.cCount;
                        logged_in_users_p.innerHTML = data.uCount;
                        break;

                    case "mess":
                        messHandle(data.data)

                        //notifHandle("lillplp.com Message")

                        break;
                    case "chan_burst":

                        //$("#chanlist").append();

                        for(i = 0; i < data.data.length; i++){
                            $("#chanlist").append("<li> <button id='channel_ " + data.data[i].ident + "' onclick='changeChannel(" + data.data[i].ident + ")'> #-" + data.data[i].name + "</button> </li>");
                        }
                        channels = data.data;
                        changeChannel(0);

                        //$("#chanlist").html(JSON.stringify(data.data));
                        
                        break;
                }

            };




            function changeChannel(channel_ident) {
                channel_ident = Number(channel_ident);
                view.channel_ident = channel_ident;
                let chName = channels.find(element => element.ident == channel_ident);
                $("#curr_view").html(chName.name);


                let HTMLArr = [];
                let chanMess = chName.messages
                for(i = 0; i < chanMess.length; i++){
                    
                    HTMLArr.push("<li>"  + chanMess[i].author.name + ": " + chanMess[i].content + " </li>");
                }

                let newHTML = HTMLArr.join("");
                $("#messlist").html(newHTML)
                
                websocket.send(JSON.stringify({action: "cViewChange", channel: channel_ident}));



                //channels.find(element => element.ident == 0)

            }


            function apiCall(command) {
                
            }


            function submitText() {
                websocket.send(JSON.stringify({action: "mess", message: text.value}));
                text.value = "";
            }

            function login() {
                let dat_tbs = JSON.stringify({
                    action: "user",
                    subact: "login",
                    name: name_field.value,
                    pass: pass_in.value
                })
                websocket.send(dat_tbs)
            }


            function updateName() {
                websocket.send(JSON.stringify({action: "user", subact: "update", type: "name", data: name_field.value}))
            }

            function messHandle(data) {
		        let datum = data

                channels.find(element => element.ident == datum.chan.ident).messages.push(datum);

                if(view["channel_ident"] == datum.chan.ident){
                    messlist.insertAdjacentHTML("beforeend", "<li>"  + datum.author.name + ": "  + datum.content + " </li>");
                }
                

                //changeChannel(view,channel_ident);
                notifHandle(datum.content + " In " + datum.chan.name + " By " + datum.author.name);
                
                
		
            }

            function notifHandle(title) {
                if (Notification.permission === "granted") {
                    //notif = new Notification("lillplp.com Message");
                    notif = new Notification(title);
                }
            }



            

        







        </script>
    </body>
</html>